<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
</head>

<body>
<div class="container-fluid">
    <div class="row">
        <div class="col-sm-4 sidebar categories">
            <h2>Categories</h2>
            <section id="category-list">
                <ul></ul>
            </section>
            <section id="add-category">
            </section>
        </div>
        <div class="col-sm-8 sessions">
            <h2>Sessions</h2>
            <section id="main">
            </section>
            <section id="input">
            </section>
        </div>
    </div>
</div>
</div>

<!-- Templates -->
<script type="text/template" id="item-template">
    <table>
        <thead>
        <tr>
            <th>Title</th>
            <th>Category</th>
            <th>Organizer</th>
        </tr>
        </thead>
        <tbody>
        <% sessions.forEach(function(session) { %>
        <tr>
            <td><%= session.get('title') %></td>
            <td><%= session.get('category') %></td>
            <td><%= session.get('organizer') %></td>
            <td>
                <button>Sign Up</button>
            </td>
        </tr>
        <% }); %>
        </tbody>
    </table>
</script>

<script type="text/template" id="input-template">
    <div class="add-session">
        <form class="add-form">
            <input name="input-title" type="text" placeholder="Title...">
            <input name="input-category" type="text" placeholder="Category...">
            <input name="input-organizer" type="text" placeholder="Organizer...">
            <button class="add-session" type="submit">Add</button>
        </form>
    </div>
</script>

<script type="text/template" id="category-template">
    <ul>
        <% console.log('hej', categories); categories.forEach(function(category) { %>
        <a href="#">
            <li class="cat-item"> <%= category.get('category') %>  <span
                    class="glyphicon glyphicon-ok hide"
                    aria-hidden="true"></span></li>
        </a>
        <% }); %>
    </ul>
</script>

<script type="text/template" id="add-category-template">
    <form class="add-category-input">
        <input name="new-category" type="text" placeholder="Add new category...">
        <button class="add-category" type="submit">Add</button>
    </form>
</script>

<!--=====================-->
<!--Libraries-->
<!--=====================-->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<link rel="stylesheet" href="categories.css">
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore.js"
        type="text/javascript"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/json3/3.3.2/json3.min.js" type="text/javascript"></script>
<script sr="https://cdnjs.cloudflare.com/ajax/libs/json2/20150503/json2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.2.3/backbone.js" type="text/javascript"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/backbone-localstorage.js/1.0/backbone.localStorage-min.js"
        type="text/javascript"></script>

<!--=====================-->


<script type="text/javascript">
    (function ($) {

        <!--=====================-->
        <!-- Models -->
        <!--=====================-->

        var Category = Backbone.Model.extend({
            defaults: {
                category: '',
                marked: false
            }
        });

        var Session = Backbone.Model.extend({
            defaults: {
                title: '',
                category: '',
                organizer: ''
            }
        });

        var session1 = new Session({title: '1', category: 'Web', organizer: 'GNK'});
        var session2 = new Session({title: '2', category: 'Android', organizer: 'Albin'});
        var session3 = new Session({title: '3', category: 'Web', organizer: 'GNK'});
        var session4 = new Session({title: '4', category: 'Android', organizer: 'Albin'});

        <!--=====================-->
        <!-- Collections -->
        <!--=====================-->

        var SessionList = Backbone.Collection.extend({
            url: '#',
            model: Session,
            tagName: 'li',
            localStorage: new Store("session-list-store"),
            initialize: function () {
                console.log('initializing...');
            }
        });

        var sessionList = new SessionList([session1, session2, session3, session4]);
        console.log(sessionList.toJSON());

        var CategoryList = Backbone.Collection.extend({
            url: '#',
            model: Category,
            localStorage: new Store('categories-list'),
            initialize: function () {
                console.log('initializing...');
            }
        });




        var categoryList = new CategoryList([{category: 'Android'}, {category: 'iOS'}, {category: 'Web'}, {category: 'Cloud'}]);
        console.log(categoryList);
        var selItemsList;
        <!--=====================-->
        <!-- Views -->
        <!--=====================-->


        var CategoryListView = Backbone.View.extend({
            el: '#category-list',
            model: Category,

            initialize: function () {
                this.render();
            },

            render: function () {
                var template = _.template($('#category-template').html());
                this.$el.html(template({categories: categoryList}));
                console.log(template);
                console.log('render: ' + JSON.stringify(categoryList));
            },

            events: {
                'click .cat-item': 'mark'
            },

            mark: function (e) {
                if ($(e.target).children('.glyphicon').hasClass('hide')) {
                    $(e.target).children('.glyphicon').removeClass('hide');
                    var cat = $(e.target).text().trim();
                    mCat = categoryList.where({category: cat});
                    mCat[0].set('marked', true);
                    selItemsList = categoryList.where({marked: true}); //new category collection with only marked: true models
                    console.log('selItemsList: ', selItemsList);
                    sessionListView.render();

                } else {
                    $(e.target).children('.glyphicon').addClass('hide');
                    var cat = $(e.target).text().trim();
                    mCat = categoryList.where({category: cat});
                    mCat[0].set('marked', false);
                    selItemsList = categoryList.where({marked: true});
                    sessionListView.render();
                }
            }
        });

        categoryListView = new CategoryListView();

        var CategoryInputView = Backbone.View.extend({
            el: '#add-category',
            model: Category,

            initialize: function () {
                this.render();
            },

            render: function () {
                var template = _.template($('#add-category-template').html(), {});
                this.$el.html(template);
            },

            events: {
                'submit': 'submit'
            },

            submit: function (e) {
                e.preventDefault();
                var category = $('.add-category-input').find('input[type=text]').val();
                console.log(category);
                var newCategory = new Category({category: category});
                categoryList.add(newCategory.toJSON(), {});
                console.log(categoryList);
                this.clear();
                categoryListView.render();
            },

            clear: function () {
                $('.add-category-input').find('input[type=text]').val('');
            }
        });

        categoryInputView = new CategoryInputView();

        var SessionView = Backbone.View.extend({
            model: Session,
            render: function () {
                return this;
            }
        });
        sessionView = new SessionView();

        var SessionListView = Backbone.View.extend({
            el: '#main',
            model: Session,

            initialize: function () {
                this.render();
            },

            render: function () {
                var template = _.template($('#item-template').html());
                console.log('selItemsList: ' + JSON.stringify(selItemsList));
                if (selItemsList && selItemsList.length !== 0) {
                    var selCats = selItemsList.map(function(category) {
                        return category.get('category');
                    });
                    var selSess = sessionList.filter(function(session) {
                        var cat = session.get('category');
                        if(selCats.indexOf(cat) !== -1) {
                            return true;
                        } else return false;
                    });
                    console.log(JSON.stringify(selSess));
                    this.$el.html(template({sessions: selSess}));
                } else {
                    this.$el.html(template({sessions: sessionList}));
                }
            }
        });

        sessionListView = new SessionListView();
        console.log(selItemsList);


        var InputView = Backbone.View.extend({
            el: '#input',
            model: Session,

            initialize: function () {
                this.render();
            },

            render: function () {
                var template = _.template($('#input-template').html(), {});
                this.$el.html(template);
            },

            events: {
                'submit': 'submit'
            },

            clear: function () {
                $('.add-form').find('input[type=text]').val('');
            },

            submit: function (e) {
                e.preventDefault();
                var title = $('.add-form').find('input[name=input-title]').val();
                var category = $('.add-form').find('input[name=input-category]').val();
                var organizer = $('.add-form').find('input[name=input-organizer]').val();
                var addedSession = new Session({title: title, category: category, organizer: organizer});
                sessionList.add(addedSession.toJSON(), {});
                console.log(sessionList);
                sessionListView.render();
                this.clear();
            }

        });

        inputView = new InputView();

    })(jQuery);


</script>


</body>
</html>